<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Key-Hand 打字练习</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .keyboard {
            display: grid;
            grid-template-columns: repeat(15, 1fr);
            gap: 5px;
            margin: 20px 0;
            padding: 20px;
            background-color: #2d2d2d;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .key {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #3d3d3d;
            color: #ffffff;
            border: 1px solid #4d4d4d;
            border-radius: 5px;
            font-size: 14px;
            cursor: default;
            transition: all 0.2s;
            position: relative;
        }

        .key.active {
            background-color: #4CAF50;
            transform: scale(0.95);
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        .key.error {
            background-color: #f44336;
            animation: shake 0.5s;
        }

        .key.current {
            background-color: #2196F3;
            box-shadow: 0 0 15px rgba(33, 150, 243, 0.7);
        }

        .key.finger-hint::after {
            content: attr(data-finger);
            position: absolute;
            bottom: -20px;
            font-size: 12px;
            color: #888;
        }

        .practice-area {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background-color: #2d2d2d;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .word-display {
            font-size: 2em;
            margin: 20px 0;
            color: #ffffff;
            letter-spacing: 2px;
        }

        .word-display .current {
            color: #2196F3;
            text-decoration: underline;
        }

        .word-display .correct {
            color: #4CAF50;
        }

        .word-display .incorrect {
            color: #f44336;
            text-decoration: line-through;
        }

        .input-area {
            margin: 20px 0;
        }

        #wordInput {
            width: 300px;
            padding: 10px;
            font-size: 1.2em;
            background-color: #3d3d3d;
            color: #ffffff;
            border: 1px solid #4d4d4d;
            border-radius: 5px;
            text-align: center;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 20px;
            background-color: #2d2d2d;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .stat-item {
            text-align: center;
            padding: 10px;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #4CAF50;
        }

        .stat-label {
            font-size: 0.9em;
            color: #888;
        }

        .letter-stats {
            margin: 20px 0;
            padding: 20px;
            background-color: #2d2d2d;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .letter-stats h3 {
            text-align: center;
            margin-bottom: 15px;
            color: #ffffff;
        }

        .letter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }

        .letter-stat-item {
            background-color: #3d3d3d;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }

        .letter {
            font-size: 1.5em;
            font-weight: bold;
            color: #ffffff;
        }

        .error-rate {
            color: #f44336;
            font-size: 0.9em;
        }

        .total-typed {
            color: #888;
            font-size: 0.8em;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .special-key {
            grid-column: span 2;
        }

        .space-key {
            grid-column: span 7;
        }

        .tab-key {
            grid-column: span 2;
        }

        .caps-key {
            grid-column: span 2;
        }

        .shift-key {
            grid-column: span 2;
        }

        .enter-key {
            grid-column: span 2;
        }

        .backspace-key {
            grid-column: span 2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Key-Hand 打字练习</h1>
        
        <div class="keyboard" id="keyboard">
            <!-- 键盘布局将通过JavaScript动态生成 -->
        </div>

        <div class="practice-area">
            <div class="word-display" id="wordDisplay"></div>
            <div class="input-area">
                <input type="text" id="wordInput" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
            </div>
        </div>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="wpm">0</div>
                <div class="stat-label">WPM</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="bestWpm">0</div>
                <div class="stat-label">最佳速度</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="practiceTime">00:00</div>
                <div class="stat-label">练习时间</div>
            </div>
        </div>

        <div class="letter-stats">
            <h3>字母统计</h3>
            <div class="letter-grid" id="letterStats">
                <!-- 字母统计将通过JavaScript动态生成 -->
            </div>
        </div>
    </div>

    <script>
        // 键盘布局数据
        const keyboardLayout = [
            ['~', '1', '2', '3', '4', '5', '6', '7', '8', '9', '0', '-', '=', 'Backspace'],
            ['Tab', 'q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p', '[', ']', '\\'],
            ['Caps', 'a', 's', 'd', 'f', 'g', 'h', 'j', 'k', 'l', ';', "'", 'Enter'],
            ['Shift', 'z', 'x', 'c', 'v', 'b', 'n', 'm', ',', '.', '/', 'Shift'],
            ['Space']
        ];

        // 手指映射
        const fingerMap = {
            'q': '左手小指', 'a': '左手小指', 'z': '左手小指',
            'w': '左手无名指', 's': '左手无名指', 'x': '左手无名指',
            'e': '左手中指', 'd': '左手中指', 'c': '左手中指',
            'r': '左手食指', 'f': '左手食指', 'v': '左手食指',
            't': '左手食指', 'g': '左手食指', 'b': '左手食指',
            'y': '右手食指', 'h': '右手食指', 'n': '右手食指',
            'u': '右手食指', 'j': '右手食指', 'm': '右手食指',
            'i': '右手中指', 'k': '右手中指', ',': '右手中指',
            'o': '右手无名指', 'l': '右手无名指', '.': '右手无名指',
            'p': '右手小指', ';': '右手小指', '/': '右手小指',
            '[': '右手小指', "'": '右手小指',
            ']': '右手小指', '\\': '右手小指',
            '`': '左手小指', '1': '左手小指', '2': '左手无名指',
            '3': '左手中指', '4': '左手食指', '5': '左手食指',
            '6': '右手食指', '7': '右手食指', '8': '右手中指',
            '9': '右手无名指', '0': '右手小指', '-': '右手小指',
            '=': '右手小指'
        };

        // 特殊键的类名映射
        const specialKeyClasses = {
            'Tab': 'tab-key',
            'Caps': 'caps-key',
            'Shift': 'shift-key',
            'Enter': 'enter-key',
            'Backspace': 'backspace-key',
            'Space': 'space-key'
        };

        // 初始化键盘
        function initKeyboard() {
            const keyboard = document.getElementById('keyboard');
            keyboard.innerHTML = '';

            keyboardLayout.forEach(row => {
                row.forEach(key => {
                    const keyElement = document.createElement('div');
                    keyElement.className = `key ${specialKeyClasses[key] || ''}`;
                    keyElement.textContent = key;
                    keyElement.dataset.key = key.toLowerCase();
                    
                    if (fingerMap[key.toLowerCase()]) {
                        keyElement.classList.add('finger-hint');
                        keyElement.dataset.finger = fingerMap[key.toLowerCase()];
                    }
                    
                    keyboard.appendChild(keyElement);
                });
            });
        }

        // 更新键盘状态
        function updateKeyboard(key, isActive, isError = false) {
            const keyElement = document.querySelector(`.key[data-key="${key.toLowerCase()}"]`);
            if (keyElement) {
                keyElement.classList.remove('active', 'error');
                if (isActive) {
                    keyElement.classList.add(isError ? 'error' : 'active');
                }
            }
        }

        // 更新单词显示
        function updateWordDisplay(word, currentIndex, hasError) {
            const wordDisplay = document.getElementById('wordDisplay');
            wordDisplay.innerHTML = '';

            word.split('').forEach((char, index) => {
                const span = document.createElement('span');
                if (index < currentIndex) {
                    span.className = 'correct';
                } else if (index === currentIndex) {
                    span.className = 'current';
                }
                span.textContent = char;
                wordDisplay.appendChild(span);
            });

            if (hasError) {
                wordDisplay.classList.add('error');
            } else {
                wordDisplay.classList.remove('error');
            }
        }

        // 打字速度计算
        let startTime = null;
        let correctChars = 0;
        let bestWpm = 0;

        function calculateWPM() {
            if (!startTime) {
                startTime = Date.now();
                return 0;
            }

            const currentTime = Date.now();
            const minutes = (currentTime - startTime) / 60000;
            const wpm = Math.round((correctChars / 5) / minutes);
            return wpm;
        }

        // 更新统计显示
        function updateStats() {
            const wpm = calculateWPM();
            document.getElementById('wpm').textContent = wpm;
            
            if (wpm > bestWpm) {
                bestWpm = wpm;
                document.getElementById('bestWpm').textContent = bestWpm;
            }

            const currentTime = Date.now();
            const elapsedSeconds = Math.floor((currentTime - startTime) / 1000);
            const minutes = Math.floor(elapsedSeconds / 60);
            const seconds = elapsedSeconds % 60;
            document.getElementById('practiceTime').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // 更新字母统计
        async function updateLetterStats(letter, isCorrect) {
            try {
                const response = await fetch('/update_letter_stats', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: '1', // 临时使用固定用户ID
                        letter: letter,
                        is_correct: isCorrect
                    })
                });

                if (!response.ok) {
                    throw new Error('更新字母统计失败');
                }
            } catch (error) {
                console.error('更新字母统计时出错:', error);
            }
        }

        // 获取并显示字母统计
        async function updateLetterStatsDisplay() {
            try {
                const response = await fetch('/get_letter_stats?user_id=1');
                if (!response.ok) {
                    throw new Error('获取字母统计失败');
                }
                
                const stats = await response.json();
                const statsContainer = document.getElementById('letterStats');
                statsContainer.innerHTML = '';

                stats.forEach(stat => {
                    const statElement = document.createElement('div');
                    statElement.className = 'letter-stat-item';
                    statElement.innerHTML = `
                        <div class="letter">${stat.letter}</div>
                        <div class="error-rate">错误率: ${stat.error_rate}%</div>
                        <div class="total-typed">总输入: ${stat.total_typed}</div>
                    `;
                    statsContainer.appendChild(statElement);
                });
            } catch (error) {
                console.error('获取字母统计时出错:', error);
            }
        }

        // 获取新单词
        async function getNewWord() {
            try {
                const response = await fetch('/get_word');
                if (!response.ok) {
                    throw new Error('获取单词失败');
                }
                const data = await response.json();
                return data.word;
            } catch (error) {
                console.error('获取单词时出错:', error);
                return 'error';
            }
        }

        // 初始化
        let currentWord = '';
        let currentIndex = 0;
        let hasError = false;

        async function init() {
            initKeyboard();
            currentWord = await getNewWord();
            updateWordDisplay(currentWord, 0, false);
            
            // 设置定时器更新统计
            setInterval(updateStats, 1000);
            
            // 初始加载字母统计
            updateLetterStatsDisplay();
        }

        // 事件监听
        document.addEventListener('keydown', async (e) => {
            if (e.key === 'Escape') {
                // 重置当前单词
                currentIndex = 0;
                hasError = false;
                currentWord = await getNewWord();
                updateWordDisplay(currentWord, 0, false);
                return;
            }

            if (e.key.length === 1) {
                const expectedChar = currentWord[currentIndex].toLowerCase();
                const inputChar = e.key.toLowerCase();
                
                updateKeyboard(inputChar, true, inputChar !== expectedChar);
                
                if (inputChar === expectedChar) {
                    correctChars++;
                    await updateLetterStats(inputChar, true);
                    currentIndex++;
                    hasError = false;
                } else {
                    await updateLetterStats(expectedChar, false);
                    hasError = true;
                }
                
                updateWordDisplay(currentWord, currentIndex, hasError);
                
                if (currentIndex === currentWord.length) {
                    // 完成当前单词
                    currentIndex = 0;
                    hasError = false;
                    currentWord = await getNewWord();
                    updateWordDisplay(currentWord, 0, false);
                    updateLetterStatsDisplay();
                }
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.key.length === 1) {
                updateKeyboard(e.key.toLowerCase(), false);
            }
        });

        // 启动应用
        init();
    </script>
</body>
</html> 